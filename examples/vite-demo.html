<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite Demo - WebContainer Test</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 20px;
        background: #1a1a2e;
        color: #eee;
        min-height: 100vh;
      }

      h1 {
        color: #646cff;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #888;
        margin-bottom: 20px;
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        height: calc(100vh - 140px);
      }

      .panel {
        background: #16213e;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #0f3460;
      }

      .panel-title {
        font-weight: bold;
        color: #646cff;
      }

      .output {
        flex: 1;
        background: #0f0f23;
        border-radius: 4px;
        padding: 10px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 11px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .output div {
        margin-bottom: 2px;
      }

      .output .hmr {
        color: #22c55e;
        font-weight: bold;
      }

      .output .error {
        color: #ef4444;
      }

      .editor-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .file-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .file-tab {
        padding: 5px 10px;
        background: #0f3460;
        border: none;
        border-radius: 4px;
        color: #888;
        cursor: pointer;
        font-size: 12px;
      }

      .file-tab.active {
        background: #646cff;
        color: white;
      }

      .file-tab:hover {
        background: #1a4080;
      }

      textarea {
        flex: 1;
        background: #0f0f23;
        border: 1px solid #0f3460;
        border-radius: 4px;
        padding: 10px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        color: #eee;
        resize: none;
        line-height: 1.5;
      }

      textarea:focus {
        outline: none;
        border-color: #646cff;
      }

      .actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      button {
        padding: 8px 16px;
        background: #646cff;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }

      button:hover {
        background: #5555dd;
      }

      button:disabled {
        background: #444;
        cursor: not-allowed;
      }

      .preview-frame {
        flex: 1;
        border: none;
        border-radius: 4px;
        background: white;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #444;
      }

      .status-dot.running {
        background: #22c55e;
      }

      .status-dot.error {
        background: #ef4444;
      }

      .info-box {
        background: #0f3460;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 12px;
        line-height: 1.5;
      }

      .info-box code {
        background: #1a1a2e;
        padding: 2px 5px;
        border-radius: 3px;
      }

      .preview-placeholder {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #0f0f23;
        border-radius: 4px;
        color: #666;
        text-align: center;
        padding: 20px;
      }

      .preview-placeholder .icon {
        font-size: 48px;
        margin-bottom: 10px;
      }

      .hmr-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #22c55e;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        z-index: 1000;
      }

      .hmr-indicator.show {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <h1>üöÄ Vite Demo - HMR in Browser</h1>
    <p class="subtitle">
      Running Vite with Hot Module Replacement using shimmed Node.js APIs
    </p>

    <div class="hmr-indicator" id="hmr-indicator">üî• HMR Update!</div>

    <div class="container">
      <!-- Left Panel: Editor -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">üìù Editor</span>
          <div class="status">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Initializing...</span>
          </div>
        </div>

        <div class="file-tabs" id="file-tabs">
          <button class="file-tab active" data-file="/src/App.jsx">App.jsx</button>
          <button class="file-tab" data-file="/src/Counter.jsx">Counter.jsx</button>
          <button class="file-tab" data-file="/src/main.jsx">main.jsx</button>
          <button class="file-tab" data-file="/src/style.css">style.css</button>
        </div>

        <div class="editor-container">
          <textarea id="editor" placeholder="Loading..."></textarea>
        </div>

        <div class="actions">
          <button id="save-btn" disabled>üíæ Save (triggers HMR)</button>
          <button id="install-btn" disabled style="background: #22c55e;">üì¶ Install Vite</button>
          <button id="run-btn" disabled style="background: #ef4444;">üöÄ Start Preview</button>
        </div>
      </div>

      <!-- Middle Panel: Preview -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">üñ•Ô∏è Live Preview</span>
          <button id="refresh-btn" style="padding: 4px 8px; font-size: 12px;">‚Üª Refresh</button>
        </div>

        <div class="preview-placeholder" id="preview-placeholder">
          <div class="icon">üöÄ</div>
          <div>Click <strong>"Start Preview"</strong> to launch the dev server</div>
          <div style="margin-top: 10px; color: #888;">Uses Service Worker for fast, Vite-like experience</div>
        </div>

        <iframe id="preview-frame" class="preview-frame" style="display: none;"></iframe>
      </div>

      <!-- Right Panel: Console Output -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">üìã Console</span>
          <button id="clear-btn" style="padding: 4px 8px; font-size: 12px;">Clear</button>
        </div>
        <div class="output" id="output"></div>
      </div>
    </div>

    <script type="module">
      import { initViteDemo, installVite, startDevServer, VirtualFS, Runtime, PackageManager } from './src/vite-demo.ts';

      const outputEl = document.getElementById('output');
      const editorEl = document.getElementById('editor');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const saveBtn = document.getElementById('save-btn');
      const clearBtn = document.getElementById('clear-btn');
      const installBtn = document.getElementById('install-btn');
      const runBtn = document.getElementById('run-btn');
      const refreshBtn = document.getElementById('refresh-btn');
      const fileTabsEl = document.getElementById('file-tabs');
      const previewFrame = document.getElementById('preview-frame');
      const previewPlaceholder = document.getElementById('preview-placeholder');
      const hmrIndicator = document.getElementById('hmr-indicator');

      let vfs = null;
      let runtime = null;
      let npm = null;
      let devServer = null;
      let devServerUrl = null;
      let currentFile = '/src/App.jsx';
      let previewActive = false;

      function log(message, className = '') {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (className) line.className = className;
        outputEl.appendChild(line);
        outputEl.scrollTop = outputEl.scrollHeight;
      }

      function setStatus(status, text) {
        statusDot.className = 'status-dot ' + status;
        statusText.textContent = text;
      }

      function showHmrIndicator() {
        hmrIndicator.classList.add('show');
        setTimeout(() => hmrIndicator.classList.remove('show'), 2000);
      }

      function loadFile(path) {
        if (!vfs) return;

        try {
          const content = vfs.readFileSync(path, 'utf8');
          editorEl.value = content;
          currentFile = path;

          // Update active tab
          document.querySelectorAll('.file-tab').forEach((tab) => {
            tab.classList.toggle('active', tab.dataset.file === path);
          });
        } catch (e) {
          log(`Error loading ${path}: ${e.message}`, 'error');
        }
      }

      function saveFile() {
        if (!vfs || !currentFile) return;

        try {
          vfs.writeFileSync(currentFile, editorEl.value);
          log(`üíæ Saved: ${currentFile}`);

          // HMR is now automatically handled by ViteDevServer via file watching
          // The BroadcastChannel in the iframe will receive the update
          if (previewActive && !devServer) {
            // Fallback for legacy blob URL mode
            updatePreview();
          }
        } catch (e) {
          log(`Error saving ${currentFile}: ${e.message}`, 'error');
        }
      }

      // Build the preview HTML with all assets inlined (React version)
      function buildPreviewHtml() {
        if (!vfs) return '';

        try {
          // Read all the source files
          const css = vfs.readFileSync('/src/style.css', 'utf8');
          let mainJsx = vfs.readFileSync('/src/main.jsx', 'utf8');
          let appJsx = vfs.readFileSync('/src/App.jsx', 'utf8');
          let counterJsx = vfs.readFileSync('/src/Counter.jsx', 'utf8');

          // Remove import/export statements - we'll use global React
          const cleanJsx = (code) => {
            return code
              .replace(/^\s*import\s+.*$/gm, '')
              .replace(/^\s*export\s+default\s+/gm, '')
              .replace(/^\s*export\s+/gm, '');
          };

          counterJsx = cleanJsx(counterJsx);
          appJsx = cleanJsx(appJsx);
          mainJsx = cleanJsx(mainJsx);

          // Fix the main.jsx to use our inlined components
          mainJsx = mainJsx
            .replace('ReactDOM.createRoot', 'window.ReactDOM.createRoot')
            .replace('<App />', '<App />');

          // Note: We break up 'script' to prevent Vite from parsing these as real script tags
          const scriptOpen = '<scr' + 'ipt';
          const scriptClose = '</scr' + 'ipt>';

          // Build complete HTML with React from CDN
          const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React + Vite Browser Demo</title>
  <style>${css}</style>
  ${scriptOpen} src="https://unpkg.com/react@18/umd/react.development.js" crossorigin>${scriptClose}
  ${scriptOpen} src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin>${scriptClose}
  ${scriptOpen} src="https://unpkg.com/@babel/standalone/babel.min.js">${scriptClose}
</head>
<body>
  <div id="root"></div>
  ${scriptOpen} type="text/babel" data-type="module">
    const { useState } = React;

    // === Counter.jsx ===
    ${counterJsx}

    // === App.jsx ===
    ${appJsx}

    // === main.jsx ===
    ${mainJsx}
  ${scriptClose}
</body>
</html>`;

          return html;
        } catch (e) {
          console.error('Error building preview:', e);
          return `<html><body style="font-family: sans-serif; padding: 20px;"><h1>Error</h1><pre>${e.message}</pre></body></html>`;
        }
      }

      function updatePreview() {
        if (!previewActive || !devServerUrl) return;

        // Force iframe refresh by adding timestamp
        const url = devServerUrl + '?t=' + Date.now();
        previewFrame.src = url;
      }

      async function startPreview() {
        previewPlaceholder.style.display = 'none';
        previewFrame.style.display = 'block';
        previewActive = true;

        if (devServerUrl) {
          previewFrame.src = devServerUrl;
        }

        log('üöÄ Preview started!');
        log('üí° Edit a file and save to see HMR in action', 'hmr');
      }

      // Initialize
      async function init() {
        try {
          setStatus('', 'Initializing...');

          const result = await initViteDemo(outputEl, null);
          vfs = result.vfs;
          runtime = result.runtime;
          npm = result.npm;

          // Set up file watcher for HMR
          vfs.watch('/src', { recursive: true }, (eventType, filename) => {
            if (eventType === 'change' && previewActive) {
              log(`üìÅ File ${eventType}: ${filename}`);
            }
          });

          // Enable buttons
          saveBtn.disabled = false;
          installBtn.disabled = false;
          runBtn.disabled = false;  // Start Preview works without npm install now!

          // Load initial file
          loadFile(currentFile);

          setStatus('running', 'Ready');
          log('');
          log('‚úÖ Demo ready! Click "Start Preview" to launch the dev server.');
          log('üí° "Install Vite" is optional - the preview uses our built-in dev server.');
        } catch (e) {
          setStatus('error', 'Error');
          log(`‚ùå Initialization error: ${e.message}`, 'error');
          console.error(e);
        }
      }

      // Install Vite
      async function doInstallVite() {
        try {
          installBtn.disabled = true;
          setStatus('', 'Installing Vite...');

          await installVite(npm, log);

          runBtn.disabled = false;
          setStatus('running', 'Vite installed');
          log('');
          log('‚úÖ Vite installed! Click "Start Preview" to launch.');
        } catch (e) {
          setStatus('error', 'Install failed');
          log(`‚ùå Install error: ${e.message}`, 'error');
          console.error(e);
          installBtn.disabled = false;
        }
      }

      // Start Preview using Service Worker-based dev server
      async function doStartPreview() {
        try {
          runBtn.disabled = true;
          setStatus('', 'Starting dev server...');

          // Start the dev server with Service Worker
          const result = await startDevServer(vfs, {
            port: 3000,
            log: log,
          });

          devServer = result.server;
          devServerUrl = result.url;

          log(`Dev server URL: ${devServerUrl}`);

          // Listen for HMR updates
          devServer.on('hmr-update', (update) => {
            log(`üî• HMR: ${update.path}`, 'hmr');
            showHmrIndicator();
          });

          // Start the preview
          await startPreview();

          setStatus('running', 'Dev server running');
        } catch (e) {
          setStatus('error', 'Preview failed');
          log(`‚ùå Preview error: ${e.message}`, 'error');
          console.error(e);
          runBtn.disabled = false;
        }
      }

      // Event listeners
      saveBtn.addEventListener('click', saveFile);

      clearBtn.addEventListener('click', () => {
        outputEl.innerHTML = '';
      });

      refreshBtn.addEventListener('click', () => {
        if (previewActive) {
          log('‚Üª Refreshing preview...');
          updatePreview();
        }
      });

      installBtn.addEventListener('click', doInstallVite);
      runBtn.addEventListener('click', doStartPreview);

      fileTabsEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('file-tab')) {
          loadFile(e.target.dataset.file);
        }
      });

      // Keyboard shortcut: Ctrl/Cmd + S to save
      editorEl.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          saveFile();
        }
      });

      // Start initialization
      init();
    </script>
  </body>
</html>
